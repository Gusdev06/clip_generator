# ğŸ‹ Guia de Deploy com Docker Run + Cookies

## ğŸ“‹ Problema

O arquivo `cookies.txt` nÃ£o estÃ¡ acessÃ­vel dentro do container quando vocÃª usa `docker run`.

## âœ… SoluÃ§Ã£o

VocÃª precisa mapear o arquivo usando a flag `-v` (volume) no `docker run`.

---

## ğŸš€ Comandos de Deploy

### **1. No servidor, coloque o cookies.txt no diretÃ³rio do projeto**

```bash
# Conecte no servidor
ssh root@seu-servidor
cd /app  # ou /root/clips_generator, onde seu projeto estÃ¡

# Verifique que o cookies.txt estÃ¡ lÃ¡
ls -la cookies.txt
```

### **2. Build da imagem**

```bash
docker build -t clips_generator .
```

### **3. Pare o container antigo (se estiver rodando)**

```bash
# Liste containers
docker ps

# Pare o container
docker stop <CONTAINER_ID ou NOME>

# Remova o container
docker rm <CONTAINER_ID ou NOME>
```

### **4. Execute com o volume mapeado**

```bash
docker run -d \
  --name clips_generator_api \
  -p 8000:8000 \
  -e OPENAI_API_KEY="sua_chave_aqui" \
  -e SUPABASE_URL="sua_url_aqui" \
  -e SUPABASE_KEY="sua_chave_aqui" \
  -e YT_COOKIES_FILE=/app/cookies.txt \
  -v /app/cookies.txt:/app/cookies.txt:ro \
  -v /app/fonts:/app/fonts:ro \
  --restart unless-stopped \
  clips_generator
```

> **âš ï¸ IMPORTANTE:** 
> - Substitua `/app/cookies.txt` pelo caminho COMPLETO no seu servidor onde o arquivo estÃ¡
> - Se seu projeto estÃ¡ em `/root/clips_generator/`, use `-v /root/clips_generator/cookies.txt:/app/cookies.txt:ro`

### **5. Verificar logs**

```bash
docker logs -f clips_generator_api
```

**Procure por:**
```
âœ… Using cookies from file: /app/cookies.txt
```

---

## ğŸ” Exemplo Completo (Ajuste os caminhos!)

```bash
# Assumindo que seu projeto estÃ¡ em /root/clips_generator/

# Build
docker build -t clips_generator /root/clips_generator

# Run com volumes corretos
docker run -d \
  --name clips_generator_api \
  -p 8000:8000 \
  -e OPENAI_API_KEY="sk-proj-..." \
  -e SUPABASE_URL="https://vlhisettgxmmozlwfnuz.supabase.co" \
  -e SUPABASE_KEY="sb_secret_..." \
  -e YT_COOKIES_FILE=/app/cookies.txt \
  -v /root/clips_generator/cookies.txt:/app/cookies.txt:ro \
  -v /root/clips_generator/fonts:/app/fonts:ro \
  -v clips_downloads:/app/downloads \
  -v clips_outputs:/app/outputs \
  --restart unless-stopped \
  clips_generator
```

---

## ğŸ§ª VerificaÃ§Ã£o RÃ¡pida

### **1. Container estÃ¡ rodando?**
```bash
docker ps | grep clips_generator
```

### **2. Arquivo existe dentro do container?**
```bash
docker exec clips_generator_api ls -la /app/cookies.txt
```

**Deve mostrar:**
```
-rw-r--r-- 1 root root 2156 Jan 30 19:13 /app/cookies.txt
```

### **3. VariÃ¡vel de ambiente configurada?**
```bash
docker exec clips_generator_api env | grep YT_COOKIES
```

**Deve mostrar:**
```
YT_COOKIES_FILE=/app/cookies.txt
```

### **4. ConteÃºdo do arquivo (primeiras linhas)?**
```bash
docker exec clips_generator_api head -3 /app/cookies.txt
```

**Deve mostrar algo como:**
```
# Netscape HTTP Cookie File
# This file is generated by yt-dlp.  Do not edit.

.youtube.com    TRUE    /       TRUE    1801112322      __Secure-YENID  12.YTE=...
```

---

## ğŸ¯ Teste Funcional

```bash
# Teste de health
curl http://localhost:8000/health

# Teste de download (substitua VIDEO_ID)
curl -X POST http://localhost:8000/viral \
  -H "Content-Type: application/json" \
  -d '{"url": "https://www.youtube.com/watch?v=lXP_JM6dBuk"}'

# Acompanhe os logs
docker logs -f clips_generator_api
```

---

## ğŸ†˜ Troubleshooting

### **Erro: "File not found: cookies.txt"**

```bash
# Verifique o caminho no HOST
ls -la /caminho/completo/cookies.txt

# Use o caminho absoluto correto no -v
docker run ... -v /caminho/completo/cookies.txt:/app/cookies.txt:ro ...
```

### **Erro: Ainda diz "Sign in to confirm you're not a bot"**

1. **Verifique se o arquivo estÃ¡ sendo lido:**
   ```bash
   docker logs clips_generator_api | grep "Using cookies"
   ```
   
   Deve aparecer: `Using cookies from file: /app/cookies.txt`

2. **Se nÃ£o aparecer, o arquivo nÃ£o estÃ¡ sendo encontrado**
   ```bash
   # Verifique dentro do container
   docker exec clips_generator_api cat /app/cookies.txt
   ```

3. **Se mostrar erro de permissÃ£o:**
   ```bash
   # No host, ajuste permissÃµes
   chmod 644 /caminho/cookies.txt
   ```

### **Container nÃ£o inicia apÃ³s mudanÃ§as**

```bash
# Remova tudo e comece do zero
docker stop clips_generator_api
docker rm clips_generator_api
docker rmi clips_generator

# Rebuild e run novamente
docker build -t clips_generator .
docker run -d ... (comando completo acima)
```

---

## ğŸ“ Script Pronto para Deploy

Crie um arquivo `deploy.sh` no servidor:

```bash
#!/bin/bash

# ConfiguraÃ§Ãµes
PROJECT_DIR="/root/clips_generator"  # AJUSTE AQUI
IMAGE_NAME="clips_generator"
CONTAINER_NAME="clips_generator_api"

cd $PROJECT_DIR

# Para e remove container antigo
docker stop $CONTAINER_NAME 2>/dev/null
docker rm $CONTAINER_NAME 2>/dev/null

# Build nova imagem
echo "ğŸ”¨ Building image..."
docker build -t $IMAGE_NAME .

# Run novo container
echo "ğŸš€ Starting container..."
docker run -d \
  --name $CONTAINER_NAME \
  -p 8000:8000 \
  -e OPENAI_API_KEY="$(grep OPENAI_API_KEY .env | cut -d '=' -f2)" \
  -e SUPABASE_URL="$(grep SUPABASE_URL .env | cut -d '=' -f2)" \
  -e SUPABASE_KEY="$(grep SUPABASE_KEY .env | cut -d '=' -f2)" \
  -e YT_COOKIES_FILE=/app/cookies.txt \
  -v $PROJECT_DIR/cookies.txt:/app/cookies.txt:ro \
  -v $PROJECT_DIR/fonts:/app/fonts:ro \
  -v clips_downloads:/app/downloads \
  -v clips_outputs:/app/outputs \
  --restart unless-stopped \
  $IMAGE_NAME

# Mostra logs
echo "ğŸ“‹ Container logs:"
sleep 2
docker logs $CONTAINER_NAME

echo "âœ… Deploy complete!"
echo "ğŸ” Check status: docker ps"
echo "ğŸ“‹ View logs: docker logs -f $CONTAINER_NAME"
```

**Uso:**
```bash
chmod +x deploy.sh
./deploy.sh
```
